/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/pouchdb-find@8.0.1/lib/index-browser.es.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{generateErrorFromResponse as e}from"/npm/pouchdb-errors@8.0.1/+esm";import{Headers as n}from"/npm/pouchdb-fetch@8.0.1/+esm";import r from"/npm/pouchdb-abstract-mapreduce@8.0.1/+esm";import{stringMd5 as t}from"/npm/pouchdb-md5@8.0.1/+esm";import{collate as i}from"/npm/pouchdb-collate@8.0.1/+esm";import{matchesSelector as o,parseField as s,compare as u,massageSelector as a,getValue as d,filterInMemoryFields as f,getFieldFromDoc as c,setFieldInDoc as l,getKey as y}from"/npm/pouchdb-selector-core@8.0.1/+esm";import{toPromise as p,isRemote as v,clone as m,nextTick as h,upsert as g,assign as k}from"/npm/pouchdb-utils@8.0.1/+esm";function b(e){return(e=m(e)).index||(e.index={}),["type","name","ddoc"].forEach((function(n){e.index[n]&&(e[n]=e.index[n],delete e.index[n])})),e.fields&&(e.index.fields=e.fields,delete e.fields),e.type||(e.type="json"),e}function x(e,n,r){var t="",i=n,o=!0;if(-1!==["$in","$nin","$or","$and","$mod","$nor","$all"].indexOf(e)&&(Array.isArray(n)||(t="Query operator "+e+" must be an array.")),-1!==["$not","$elemMatch","$allMatch"].indexOf(e)&&(Array.isArray(n)||"object"!=typeof n||null===n)&&(t="Query operator "+e+" must be an object."),"$mod"===e&&Array.isArray(n))if(2!==n.length)t="Query operator $mod must be in the format [divisor, remainder], where divisor and remainder are both integers.";else{var s=n[0],u=n[1];0===s&&(t="Query operator $mod's divisor cannot be 0, cannot divide by zero.",o=!1),"number"==typeof s&&parseInt(s,10)===s||(t="Query operator $mod's divisor is not an integer.",i=s),parseInt(u,10)!==u&&(t="Query operator $mod's remainder is not an integer.",i=u)}if("$exists"===e&&"boolean"!=typeof n&&(t="Query operator $exists must be a boolean."),"$type"===e){var a=["null","boolean","number","string","array","object"],d='"'+a.slice(0,a.length-1).join('", "')+'", or "'+a[a.length-1]+'"';("string"!=typeof n||-1==a.indexOf(n))&&(t="Query operator $type must be a string. Supported values: "+d+".")}if("$size"===e&&parseInt(n,10)!==n&&(t="Query operator $size must be a integer."),"$regex"===e&&"string"!=typeof n&&(r?t="Query operator $regex must be a string.":n instanceof RegExp||(t="Query operator $regex must be a string or an instance of a javascript regular expression.")),t){if(o)t+=" Received"+(null===i?" ":Array.isArray(i)?" array":" "+typeof i)+": "+("object"==typeof i&&null!==i?JSON.stringify(i,null,"\t"):i);throw new Error(t)}}var _=["$all","$allMatch","$and","$elemMatch","$exists","$in","$mod","$nin","$nor","$not","$or","$regex","$size","$type"],$=["$in","$nin","$mod","$all"],w=["$eq","$gt","$gte","$lt","$lte"];function O(e,n){if(Array.isArray(e))for(var r of e)"object"==typeof r&&null!==s&&O(r,n);else for(var t=Object.keys(e),i=0;i<t.length;i++){var o=t[i],s=e[o];-1!==_.indexOf(o)&&x(o,s,n),-1===w.indexOf(o)&&(-1===$.indexOf(o)&&"object"==typeof s&&null!==s&&O(s,n))}}function j(r,t,i,o){var s,u;i.headers=new n({"Content-type":"application/json"}),r.fetch(t,i).then((function(e){return s=e.status,u=e.ok,e.json()})).then((function(n){if(u)o(null,n);else{n.status=s;var r=e(n);o(r)}})).catch(o)}function E(e,n,r){n=b(n),j(e,"_index",{method:"POST",body:JSON.stringify(n)},r)}function q(e,n,r){O(n.selector,!0),j(e,"_find",{method:"POST",body:JSON.stringify(n)},r)}function A(e,n,r){j(e,"_explain",{method:"POST",body:JSON.stringify(n)},r)}function M(e,n){j(e,"_index",{method:"GET"},n)}function F(e,n,r){var t=n.ddoc,i=n.type||"json",o=n.name;return t?o?void j(e,"_index/"+[t,i,o].map(encodeURIComponent).join("/"),{method:"DELETE"},r):r(new Error("you must provide an index's name")):r(new Error("you must provide an index's ddoc"))}function Q(e){return function(...n){var r=n.pop(),t=e.apply(this,n);return function(e,n){e.then((function(e){h((function(){n(null,e)}))}),(function(e){h((function(){n(e)}))}))}(t,r),t}}var N=function(...e){for(var n=[],r=0,t=e.length;r<t;r++){var i=e[r];Array.isArray(i)?n=n.concat(N.apply(null,i)):n.push(i)}return n};function U(e){for(var n={},r=0,t=e.length;r<t;r++)n=k(n,e[r]);return n}function S(e,n){for(var r=0,t=Math.min(e.length,n.length);r<t;r++)if(e[r]!==n[r])return!1;return!0}function C(e,n){if(e.length!==n.length)return!1;for(var r=0,t=e.length;r<t;r++)if(e[r]!==n[r])return!1;return!0}function I(e,n,r){var t=function(e){for(var n=0,r=e.length;n<r;n++)if(-1!==e[n].indexOf("."))return!1;return!0}(e),i=1===e.length;return t?i?function(e,n,r){return function(t){r&&!o(t,r)||n(t[e])}}(e[0],n,r):function(e,n,r){return function(t){if(!r||o(t,r)){for(var i=[],s=0,u=e.length;s<u;s++)i.push(t[e[s]]);n(i)}}}(e,n,r):i?function(e,n,r){var t=s(e);return function(e){if(!r||o(e,r)){for(var i=e,s=0,u=t.length;s<u;s++)if(void 0===(i=i[t[s]]))return;n(i)}}}(e[0],n,r):function(e,n,r){return function(t){if(!r||o(t,r)){for(var i=[],u=0,a=e.length;u<a;u++){for(var d=s(e[u]),f=t,c=0,l=d.length;c<l;c++)if(void 0===(f=f[d[c]]))return;i.push(f)}n(i)}}}(e,n,r)}var T=r("indexes",(function(e,n){return I(Object.keys(e.fields),n,e.partial_filter_selector)}),(function(){throw new Error("reduce not supported")}),(function(e,n){var r=e.views[n];if(!r.map||!r.map.fields)throw new Error("ddoc "+e._id+" with view "+n+" doesn't have map.fields defined. maybe it wasn't created by this plugin?")}));function z(e){return e._customFindAbstractMapper?{query:function(n,r){var t=T.query.bind(this);return e._customFindAbstractMapper.query.call(this,n,r,t)},viewCleanup:function(){var n=T.viewCleanup.bind(this);return e._customFindAbstractMapper.viewCleanup.call(this,n)}}:T}function J(e){return e.fields=e.fields.map((function(e){if("string"==typeof e){var n={};return n[e]="asc",n}return e})),e.partial_filter_selector&&(e.partial_filter_selector=a(e.partial_filter_selector)),e}function L(e,n){for(var r=[],t=0;t<n.def.fields.length;t++){var i=y(n.def.fields[t]);r.push(c(e,s(i)))}return r}function P(e){return e.allDocs({startkey:"_design/",endkey:"_design/￿",include_docs:!0}).then((function(e){var n={indexes:[{ddoc:null,name:"_all_docs",type:"special",def:{fields:[{_id:"asc"}]}}]};return n.indexes=N(n.indexes,e.rows.filter((function(e){return"query"===e.doc.language})).map((function(e){return(void 0!==e.doc.views?Object.keys(e.doc.views):[]).map((function(n){var r=e.doc.views[n];return{ddoc:e.id,name:n,type:"json",def:J(r.options.def)}}))}))),n.indexes.sort((function(e,n){return u(e.name,n.name)})),n.total_rows=n.indexes.length,n}))}var V=null,X={"￿":{}};const D={queryOpts:{limit:0,startkey:X,endkey:V},inMemoryFields:[]};function R(e,n){for(var r=e.def.fields.map(y),t=0,i=r.length;t<i;t++){if(n===r[t])return!0}return!1}function G(e,n){var r=e[n];return"$eq"!==y(r)}function B(e,n){var r=n.def.fields.map(y);return e.slice().sort((function(e,n){var t=r.indexOf(e),i=r.indexOf(n);return-1===t&&(t=Number.MAX_VALUE),-1===i&&(i=Number.MAX_VALUE),u(t,i)}))}function H(e,n,r,t){var i=N(e,function(e,n,r){for(var t=!1,i=0,o=(r=B(r,e)).length;i<o;i++){var s=r[i];if(t||!R(e,s))return r.slice(i);i<o-1&&G(n,s)&&(t=!0)}return[]}(n,r,t),function(e){var n=[];return Object.keys(e).forEach((function(r){var t=e[r];Object.keys(t).forEach((function(e){"$ne"===e&&n.push(r)}))})),n}(r));return B(function(e){for(var n={},r=0;r<e.length;r++)n["$"+e[r]]=!0;return Object.keys(n).map((function(e){return e.substring(1)}))}(i),n)}function K(e,n,r){if(n){var t=(s=e,!((o=n).length>s.length)&&S(o,s)),i=S(r,e);return t&&i}var o,s;return function(e,n){e=e.slice();for(var r=0,t=n.length;r<t;r++){var i=n[r];if(!e.length)break;var o=e.indexOf(i);if(-1===o)return!1;e.splice(o,1)}return!0}(r,e)}var W=["$eq","$gt","$gte","$lt","$lte"];function Y(e){return-1===W.indexOf(e)}function Z(e,n,r,t){var i=e.def.fields.map(y);return!!K(i,n,r)&&function(e,n){var r=n[e[0]];return void 0===r||!(1===Object.keys(r).length&&"$ne"===y(r))}(i,t)}function ee(e,n,r,t,i){var o=function(e,n,r,t){return t.filter((function(t){return Z(t,r,n,e)}))}(e,n,r,t);if(0===o.length){if(i)throw{error:"no_usable_index",message:"There is no index available for this selector."};var s=t[0];return s.defaultUsed=!0,s}if(1===o.length&&!i)return o[0];var u=function(e){for(var n={},r=0,t=e.length;r<t;r++)n[e[r]]=!0;return n}(n);if(i){var a="_design/"+i[0],d=2===i.length&&i[1],f=o.find((function(e){return!(!d||e.ddoc!==a||d!==e.name)||e.ddoc===a}));if(!f)throw{error:"unknown_error",message:"Could not find that index or could not use that index for the query"};return f}return function(e,n){for(var r=null,t=-1,i=0,o=e.length;i<o;i++){var s=e[i],u=n(s);u>t&&(t=u,r=s)}return r}(o,(function(e){for(var n=e.def.fields.map(y),r=0,t=0,i=n.length;t<i;t++){var o=n[t];u[o]&&r++}return r}))}function ne(e,n){var r,t=y(n.def.fields[0]),i=e[t]||{},o=[];return Object.keys(i).forEach((function(e){Y(e)&&o.push(t);var n=function(e,n){switch(e){case"$eq":return{key:n};case"$lte":return{endkey:n};case"$gte":return{startkey:n};case"$lt":return{endkey:n,inclusive_end:!1};case"$gt":return{startkey:n,inclusive_start:!1}}return{startkey:V}}(e,i[e]);r=r?U([r,n]):n})),{queryOpts:r,inMemoryFields:o}}function re(e,n){switch(e){case"$eq":return{startkey:n,endkey:n};case"$lte":return{endkey:n};case"$gte":return{startkey:n};case"$lt":return{endkey:n,inclusive_end:!1};case"$gt":return{startkey:n,inclusive_start:!1}}}function te(e,n){return n.defaultUsed?function(e){return{queryOpts:{startkey:null},inMemoryFields:[Object.keys(e)]}}(e):1===n.def.fields.length?ne(e,n):function(e,n){var r,t,i=n.def.fields.map(y),o=[],s=[],u=[];function a(e){!1!==r&&s.push(V),!1!==t&&u.push(X),o=i.slice(e)}for(var d=0,f=i.length;d<f;d++){var c=e[i[d]];if(!c||!Object.keys(c).length){a(d);break}if(Object.keys(c).some(Y)){a(d);break}if(d>0){var l="$gt"in c||"$gte"in c||"$lt"in c||"$lte"in c,p=Object.keys(e[i[d-1]]),v=C(p,["$eq"]),m=C(p,Object.keys(c));if(l&&!v&&!m){a(d);break}}for(var h=Object.keys(c),g=null,k=0;k<h.length;k++){var b=h[k],x=re(b,c[b]);g=g?U([g,x]):x}s.push("startkey"in g?g.startkey:V),u.push("endkey"in g?g.endkey:X),"inclusive_start"in g&&(r=g.inclusive_start),"inclusive_end"in g&&(t=g.inclusive_end)}var _={startkey:s,endkey:u};return void 0!==r&&(_.inclusive_start=r),void 0!==t&&(_.inclusive_end=t),{queryOpts:_,inMemoryFields:o}}(e,n)}function ie(e,n){var r=e.selector,t=e.sort;if(function(e){return Object.keys(e).map((function(n){return e[n]})).some((function(e){return"object"==typeof e&&0===Object.keys(e).length}))}(r))return k({},D,{index:n[0]});var i=function(e,n){var r,t=Object.keys(e),i=n?n.map(y):[];return r=t.length>=i.length?t:i,0===i.length?{fields:r}:{fields:r=r.sort((function(e,n){var r=i.indexOf(e);-1===r&&(r=Number.MAX_VALUE);var t=i.indexOf(n);return-1===t&&(t=Number.MAX_VALUE),r<t?-1:r>t?1:0})),sortOrder:n.map(y)}}(r,t),o=i.fields,s=ee(r,o,i.sortOrder,n,e.use_index),u=te(r,s);return{queryOpts:u.queryOpts,index:s,inMemoryFields:H(u.inMemoryFields,s,r,o)}}function oe(e,n,r){var t,o;return n.selector&&(O(n.selector,!1),n.selector=a(n.selector)),n.sort&&(n.sort=function(e){if(!Array.isArray(e))throw new Error("invalid sort json - should be an array");return e.map((function(e){if("string"==typeof e){var n={};return n[e]="asc",n}return e}))}(n.sort)),n.use_index&&(n.use_index=(t=n.use_index,o=[],"string"==typeof t?o.push(t):o=t,o.map((function(e){return e.replace("_design/","")})))),function(e){if("object"!=typeof e.selector)throw new Error("you must provide a selector when you find()")}(n),P(e).then((function(t){e.constructor.emit("debug",["find","planning query",n]);var o=ie(n,t.indexes);e.constructor.emit("debug",["find","query plan",o]);var u=o.index;!function(e,n){if(n.defaultUsed&&e.sort){var r=e.sort.filter((function(e){return"_id"!==Object.keys(e)[0]})).map((function(e){return Object.keys(e)[0]}));if(r.length>0)throw new Error('Cannot sort on field(s) "'+r.join(",")+'" when using the default index')}n.defaultUsed}(n,u);var a=k({include_docs:!0,reduce:!1,indexes_count:t.total_rows},o.queryOpts);return"startkey"in a&&"endkey"in a&&i(a.startkey,a.endkey)>0?{docs:[]}:(n.sort&&"string"!=typeof n.sort[0]&&"desc"===d(n.sort[0])&&(a.descending=!0,a=function(e){var n=m(e);return delete n.startkey,delete n.endkey,delete n.inclusive_start,delete n.inclusive_end,"endkey"in e&&(n.startkey=e.endkey),"startkey"in e&&(n.endkey=e.startkey),"inclusive_start"in e&&(n.inclusive_end=e.inclusive_start),"inclusive_end"in e&&(n.inclusive_start=e.inclusive_end),n}(a)),o.inMemoryFields.length||("limit"in n&&(a.limit=n.limit),"skip"in n&&(a.skip=n.skip)),r?Promise.resolve(o,a):Promise.resolve().then((function(){if("_all_docs"===u.name)return function(e,n){var r=m(n);return r.descending?("endkey"in r&&"string"!=typeof r.endkey&&(r.endkey=""),"startkey"in r&&"string"!=typeof r.startkey&&(r.limit=0)):("startkey"in r&&"string"!=typeof r.startkey&&(r.startkey=""),"endkey"in r&&"string"!=typeof r.endkey&&(r.limit=0)),"key"in r&&"string"!=typeof r.key&&(r.limit=0),r.limit>0&&r.indexes_count&&(r.original_limit=r.limit,r.limit+=r.indexes_count),e.allDocs(r).then((function(e){return e.rows=e.rows.filter((function(e){return!/^_design\//.test(e.id)})),r.original_limit&&(r.limit=r.original_limit),e.rows=e.rows.slice(0,r.limit),e}))}(e,a);var n,r=(n=u).ddoc.substring(8)+"/"+n.name;return z(e).query.call(e,r,a)})).then((function(e){!1===a.inclusive_start&&(e.rows=function(e,n,r){for(var t=r.def.fields,o=0,s=e.length;o<s;o++){var u=L(e[o].doc,r);if(1===t.length)u=u[0];else for(;u.length>n.length;)u.pop();if(Math.abs(i(u,n))>0)break}return o>0?e.slice(o):e}(e.rows,a.startkey,u)),o.inMemoryFields.length&&(e.rows=f(e.rows,n,o.inMemoryFields));var r={docs:e.rows.map((function(e){var r=e.doc;return n.fields?function(e,n){for(var r={},t=0,i=n.length;t<i;t++){var o=s(n[t]),u=c(e,o);void 0!==u&&l(r,o,u)}return r}(r,n.fields):r}))};return u.defaultUsed&&(r.warning="No matching index found, create an index to optimize query time."),r})))}))}var se=Q((function(e,n){n=b(n);var r,i=m(n.index);function o(){return r||(r=t(JSON.stringify(n)))}n.index=J(n.index),function(e){var n=e.fields.filter((function(e){return"asc"===d(e)}));if(0!==n.length&&n.length!==e.fields.length)throw new Error("unsupported mixed sorting")}(n.index);var s=n.name||"idx-"+o(),u=n.ddoc||"idx-"+o(),a="_design/"+u,f=!1,c=!1;return e.constructor.emit("debug",["find","creating index",a]),g(e,a,(function(e){return e._rev&&"query"!==e.language&&(f=!0),e.language="query",e.views=e.views||{},!(c=!!e.views[s])&&(e.views[s]={map:{fields:U(n.index.fields),partial_filter_selector:n.index.partial_filter_selector},reduce:"_count",options:{def:i}},e)})).then((function(){if(f)throw new Error('invalid language for ddoc with id "'+a+'" (should be "query")')})).then((function(){var n=u+"/"+s;return z(e).query.call(e,n,{limit:0,reduce:!1}).then((function(){return{id:a,name:s,result:c?"exists":"created"}}))}))})),ue=Q(oe),ae=Q((function(e,n){return oe(e,n,!0).then((function(r){return{dbname:e.name,index:r.index,selector:n.selector,range:{start_key:r.queryOpts.startkey,end_key:r.queryOpts.endkey},opts:{use_index:n.use_index||[],bookmark:"nil",limit:n.limit,skip:n.skip,sort:n.sort||{},fields:n.fields,conflicts:!1,r:[49]},limit:n.limit,skip:n.skip||0,fields:n.fields}}))})),de=Q(P),fe=Q((function(e,n){if(!n.ddoc)throw new Error("you must supply an index.ddoc when deleting");if(!n.name)throw new Error("you must supply an index.name when deleting");var r=n.ddoc,t=n.name;return g(e,r,(function(e){return 1===Object.keys(e.views).length&&e.views[t]?{_id:r,_deleted:!0}:(delete e.views[t],e)})).then((function(){return z(e).viewCleanup.apply(e)})).then((function(){return{ok:!0}}))})),ce={};ce.createIndex=p((function(e,n){if("object"!=typeof e)return n(new Error("you must provide an index to create"));(v(this)?E:se)(this,e,n)})),ce.find=p((function(e,n){if(void 0===n&&(n=e,e=void 0),"object"!=typeof e)return n(new Error("you must provide search parameters to find()"));(v(this)?q:ue)(this,e,n)})),ce.explain=p((function(e,n){if(void 0===n&&(n=e,e=void 0),"object"!=typeof e)return n(new Error("you must provide search parameters to explain()"));(v(this)?A:ae)(this,e,n)})),ce.getIndexes=p((function(e){(v(this)?M:de)(this,e)})),ce.deleteIndex=p((function(e,n){if("object"!=typeof e)return n(new Error("you must provide an index to delete"));(v(this)?F:fe)(this,e,n)}));export{ce as default};
//# sourceMappingURL=/sm/9046c0c8d737e87df9e1465b9f18d7dcc674f42d8e6f7cc8c55bfa418342acea.map