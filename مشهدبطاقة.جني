ئورد مكون، عنصرمخصص، عنصرئشتمل، عنصر؛
ئورد حدت، حدتمخصص؛
ئورد المستند من مستند؛
ئورد النافدة من نافدة؛
ئورد مسترمز من مكون.مسترمز؛
ئورد نعملا من مكون.نعملا؛
ئورد غمازة من مكون.غمازة؛
ئورد مختطبطاقة، مختطوحدة من مختطة؛
ئورد الكل ك قاعدب من قاعدب؛
ئورد سياق من سياق؛
ئورد الئان من تاريخ؛

ئورد طافية من مكون.طافية؛
ئورد الكل من مختطة؛

ئعلن مشهدبطاقة ():
	يمدد مكون()؛
	
	يملك مركب { مختطبطاقة بطاقة } حالة = {
		بطاقة: عدم
	}؛
	
	يملك حدت _عندغلقبطاقة؛
تم

ئعلن مشهدبطاقة.حممل ():
	هدا.ئربطحدتين()؛
	مسترمز مسترم = هدا.ئستعلم((<مسترمز>))؛
	مختطبطاقة بطاقتي = هدا.حالة.بطاقة؛
	مسترم.خدحالة({
		مصدر: بطاقتي.محتوا ئدا بطاقتي وئلا ''
	})؛
تم

ئعلن مشهدبطاقة.عندغلقبطاقة ():
	عنصرئشتمل ئب = المستند.ئستعلم((<مشهدبطاقات>))؛
	طافية طف = ئب.ئستعلم((<طافية>))؛
	طف.ئخفي()؛
	هدا.ئطلقحدت(حدتمخصص('غلقبطاقة'))؛
تم

ئعلن مشهدبطاقة.ئنشئوحدة (نصية مساروحدة) ك وعد:
	غمازة غم = المستند.ئستعلم((<غمازة>))؛
	مختطوحدة وح = مختطة.ئنشئوحدة(مساروحدة)؛
	ريتما قاعدب.قابمحلي.ئوضع(وح)؛
	غم.خدحالة({
		رسالة: 'تم ئنشائ الوحدة'
	})؛
تم

ئعلن مشهدبطاقة.تحققوحدة (نصية مساروحدة) ك وعد منطق:
	نعملا نعلا = هدا.ئستعلم((<نعملا>))؛
	نصية نصخطئ = ''؛
	نصية زرنعم = عدم؛
	نصية مساروح = مساروحدة؛
	ئدا مساروح.يبدئب('/'):
		نصخطئ = 'لا يجب ئن يبدئ ئسم الوحدة بالرمز /'؛
	وئلا ئدا مساروح == '':
		نصخطئ = 'يرجا تحديد مسار الوحدة'؛	
	وئلا:
		#نتحقق من وجود الوحدة
		مختطوحدة وح = ريتما قاعدب.قابمحلي.ئجلب(مساروح)؛
		ئدا ليس وح:
			نصخطئ = "الوحدة %{مساروح} غير موجودة. هل ترغب في ئنشائها؟"؛
			زرنعم = "نعم"؛
		وئلا:
			#تعديل تاريخ ئاخر تعديل
			عدد ئان = الئان()؛
			وح.ئاخرتعديل = ئان؛
			ريتما قاعدب.قابمحلي.ئوضع(وح)؛
			#ئاخر تعديل للمشروع ئيضا
			قاعدب.مشروعحالي.ئاخرتعديل = ئان؛
			مركب {نجح، معرف، مراجعة} نتج = ريتما قاعدب.قابمحلي.ئوضع(قاعدب.مشروعحالي)؛
			قاعدب.مشروعحالي._مراجعة = نتج.مراجعة؛
		تم
	تم
	ئدا نصخطئ لا= '':
		نعلا.خدحالة({
			رسالة: نصخطئ،
			زرلا: 'ئرجع'،
			زرنعم: زرنعم،
			عندنعم: (دالة(): هدا.ئنشئوحدة(مساروح))،
			ئيقو: 'تحدير-دائرة'
		})؛
		ئرجع خطئ؛
	وئلا:
		ئرجع صحيح؛
	تم
تم

ئعلن مشهدبطاقة.عندحفضبطاقة () ك وعد:
	مسترمز مسترم = هدا.ئستعلم((<مسترمز>))؛
	عنصرئشتمل حيزوحدة = هدا.ئستعلم('#حيزوحدة')؛
	نصية مساروحدة = حيزوحدة.نصداخلي.عووضكل(' '، '')؛ #نحدف المسافات
	نصية مصدر = مسترم.حالة['مصدر']؛
	
	ئدا مصدر: #البطاقة ليست فارغة
		ئدا ريتما هدا.تحققوحدة(مساروحدة):
			مختطبطاقة بطاقتي = مختطة.ئنشئبطاقة(مساروحدة، مصدر)؛
			ئدا هدا.حالة.بطاقة:
				بطاقتي._معرف = هدا.حالة.بطاقة._معرف؛
				بطاقتي._مراجعة = هدا.حالة.بطاقة._مراجعة؛
			تم
			ريتما قاعدب.قابمحلي.ئوضع(بطاقتي)؛
			هدا.عندغلقبطاقة()؛
		تم
	تم
تم

ئعلن مشهدبطاقة.ئنسخبطاقة () ك وعد:
	مسترمز مسترم = هدا.ئستعلم((<مسترمز>))؛
	غمازة غم = المستند.ئستعلم((<غمازة>))؛
	عنصرئشتمل حيزوحدة = هدا.ئستعلم('#حيزوحدة')؛
	نصية مساروحدة = حيزوحدة.نصداخلي.عووضكل(' '، '')؛ #نحدف المسافات
	نصية مصدر = مسترم.حالة['مصدر']؛
	ئدا ريتما هدا.تحققوحدة(مساروحدة):
		مختطبطاقة بطاقتي = مختطة.ئنشئبطاقة(مساروحدة، مصدر)؛
		ريتما قاعدب.قابمحلي.ئوضع(بطاقتي)؛
		غم.خدحالة({
			رسالة: 'تم ئستنساخ البطاقة'
		})؛
	تم
تم

ئعلن مشهدبطاقة.ئحدفبطاقة (مختطبطاقة بطا) ك وعد:
	غمازة غم = المستند.ئستعلم((<غمازة>))؛
	بطا._محدوف = صحيح؛
	ريتما قاعدب.قابمحلي.ئوضع(بطا)؛
	#نجلب بطاقات الوحدة
	مركب {وتيقات} نتج = ريتما قاعدب.قابمحلي.ئستعلم(
		حدد: {
			نوع: 'بطاقة'،
			وحدة: بطا.وحدة
		}
	)؛
	ئدا نتج.وتيقات.طول == 0:
		#نحدف وحدة البطاقة
		مختطوحدة وح = ريتما قاعدب.قابمحلي.ئجلب(بطا.وحدة)؛
		وح._محدوف = صحيح؛
		ريتما قاعدب.قابمحلي.ئوضع(وح)؛
		هدا.ئطلقحدت(حدتمخصص('حدفوحدة'))؛
	وئلا:
		هدا.ئطلقحدت(حدتمخصص('حدفبطاقة'))؛
	تم
	غم.خدحالة({
		رسالة: 'تم حدف البطاقة'
	})؛
	هدا.عندغلقبطاقة()؛
تم

ئعلن مشهدبطاقة.عندحدفبطاقة () ك وعد:
	مختطبطاقة بطاقتي = هدا.حالة.بطاقة؛
	نعملا نعلا = هدا.ئستعلم((<نعملا>))؛
	نعلا.خدحالة({
		رسالة: 'هل متئكد من رغبتك في حدف هده البطاقة؟'،
		عندنعم: (دالة(): هدا.ئحدفبطاقة(بطاقتي))،
		ئيقو: 'خطر-دائرة'
	})؛
تم

ئعلن مشهدبطاقة.عندنقرتراجع ():
	مسترمز مسترم = هدا.ئستعلم((<مسترمز>))؛
	مسترم.تراجع()؛
تم

ئعلن مشهدبطاقة.صيير ():
	عدد طول = النافدة.طولداخلي - 170؛
	مختطبطاقة بطاقة = هدا.حالة.بطاقة؛
	نصية مساروحدة = ' '؛
	ئدا هدا.حالة.بطاقة:
		مساروحدة = هدا.حالة.بطاقة.وحدة؛
	وئلا:
		مساروحدة = سياق.حالة.مساروحدتحالية.عووض('/'، '')؛
	تم
	ئدا مساروحدة == '':
		#نضيف مسافة للوحدة الفارغة لتمكين تعديلها
		مساروحدة = ' '؛
	تم
	نصية عنوان = 'بطاقة جديدة'؛
	ئدا هدا.حالة.بطاقة:
		ئدا هدا.حالة.بطاقة.عنوان لا= '':
			عنوان = "%{هدا.حالة.بطاقة.عنوان}()"؛
		تم
	تم
	ئرجع (
		<قسم صنف="مخطط-طولي فجوة-3 حش-4">
			<قسم صنف="مخطط-عرضي ئصفف-وسط ئرصف-وسط فجوة-3 نص-ئبيض">
				<ئيقو ئسم="سهم-تصفح-يمين" صنف="مئشر-سبابة نصكجج" عندنقر="عندغلقبطاقة"></ئيقو>
				<حيز صنف="نصكب يكبر نص-ئبيض خلف-حيادي-800 ئطاربلا">%{عنوان}</حيز>
				<ئيقو ئسم="تلاتنقط-عمودي" صنف="مئشر-سبابة نصكجج"></ئيقو>
			</قسم>
			
			<مسترمز صنف="يكبر فلكس" طول="%{طول}px"></مسترمز>
			
			<قسم صنف="مخطط-عرضي">
				<قسم صنف="مخطط-عرضي ئصفف-وسط ئرصف-وسط فجوة-3 نص-ئبيض ئطار-رمادي-700 حشص-1 حشس-2 مقوس ئطار1">
					<ئيقو ئسم="مربع-قوس-كود"></ئيقو>
					<قسم صنف="مخطط-عرضي">
						<حيز>/</حيز>
						<حيز معرف="حيزوحدة" قابلتعديل="plaintext-only">%{مساروحدة}</حيز>
					</قسم>
				</قسم>
			</قسم>
			
			<قسم صنف="مخطط-عرضي ئرصف-بين ئصفف-وسط">
				<قسم صنف="مخطط-عرضي فجوة-1 نص-ئبيض">
					<ئيقو ئسم="حادي-يمين" صنف="مئشر-سبابة نصكج مقوسكامل تئشير:خلف-حيادي-700 حشص-2 حشس-3"></ئيقو>
					<ئيقو ئسم="تكرار" عندنقر="عندنقرتراجع" صنف="مئشر-سبابة نصكج مقوسكامل تئشير:خلف-حيادي-700 حشص-2 حشس-3"></ئيقو>
					<ئيقو ئسم="تراجع" صنف="مئشر-سبابة نصكج مقوسكامل تئشير:خلف-حيادي-700 حشص-2 حشس-3"></ئيقو>
					<ئيقو ئسم="نسخ" عندنقر="ئنسخبطاقة" صنف="مئشر-سبابة نصكج مقوسكامل تئشير:خلف-حيادي-700 حشص-2 حشس-3"></ئيقو>
					<ئيقو ئسم="قمامة" عندنقر="عندحدفبطاقة" صنف="مئشر-سبابة نصكج مقوسكامل تئشير:خلف-حيادي-700 حشص-2 حشس-3"></ئيقو>
				</قسم>
				<حيز عندنقر="عندحفضبطاقة" صنف="مئشر-سبابة خطسميك نص-ئبيض مقوسكب حشس-6 حشص-2 تئشير:خلف-حيادي-700">حفض</حيز>
			</قسم>
			
		</قسم>
		
		<نعملا صنف="داكن" نبرة="ئحمر-700"></نعملا>
	)؛
تم

ئعلن مدخل ():
	عنصرمخصص.سججل('مشهدبطاقة'، مشهدبطاقة)؛
تم
